{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2022/04/14/reduce-docker-image-size","result":{"data":{"site":{"siteMetadata":{"title":"<bbon />","siteUrl":"https://bbon.me"}},"markdownRemark":{"id":"c9b66ce3-0836-515b-bfe7-34a86dff1abe","excerpt":"GitHub Actions 의 워크플로우를 이용해서 ASP.NET Core 응용프로그램을 도커 이미지로 빌드해서 사설 도커 레지스트리에 업로드하고 있습니다. GitHub: bing-wallpaper docker image workflow…","html":"<p><a href=\"https://github.com/bbonkr/bing-wallpaper/actions/workflows/docker.yml\">GitHub Actions 의 워크플로우</a>를 이용해서 ASP.NET Core 응용프로그램을 도커 이미지로 빌드해서 사설 도커 레지스트리에 업로드하고 있습니다.</p>\n<p><a href=\"https://github.com/bbonkr/bing-wallpaper/actions/workflows/docker.yml\">GitHub: bing-wallpaper docker image workflow</a> 에서 동작을 확인하실 수 있습니다.</p>\n<p>언젠가 부터 워크플로우가 실패하고 있었습니다.</p>\n<p><a href=\"https://github.com/bbonkr/bing-wallpaper/actions/runs/2089159258\">Merge pull request #114 from bbonkr/dev docker image #17</a></p>\n<p>오류 메시지는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"plaintext\"><pre class=\"language-plaintext\"><code class=\"language-plaintext\">buildx failed with: error: failed to solve: failed to copy: unexpected status: 413 Request Entity Too Large</code></pre></div>\n<p>오류 메시지를 참조해서 원인 해결을 위해 검색을 해보면 사설 도커 레지스트리 환경에서 허용 업로드 크기를 초과한 경우 발생하는 메시지로 판단됩니다.</p>\n<p>하지만, 도커 레지스트리 실행환경에는 허용 업로드 크기를 제한하고 있지 않습니다.</p>\n<p>nginx 허용 업로드 크기관련 구성은 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"plaintext\"><pre class=\"language-plaintext\"><code class=\"language-plaintext\">http {\n  client_max_body_size 0;\n}</code></pre></div>\n<p>서버 측에서 문제를 해결할 수 없다고 생각되어 도커 이미지 크기를 줄이기로 결정했습니다.</p>\n<h2>확인</h2>\n<h3>응용프로그램 출력 크기 확인</h3>\n<p>dotnet cli 게시 명령으로 출력해서 크기를 확인해보니 아래와 같이 크기가 확인됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ dotnet publish ./src/Bing.Wallpaper/Bing.Wallpaper.csproj <span class=\"token parameter variable\">-c</span> Release <span class=\"token parameter variable\">-o</span> ./test-out</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">du</span> <span class=\"token parameter variable\">-sh</span> ./test-out\n298M\t./test-out</code></pre></div>\n<p>생각보다 크기가 큽니다.</p>\n<p>실행되는 환경이 linux x64 환경으로 제한되니, 출력 크기를 줄이기 위해 플랫폼을 지정해서 확인합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ dotnet publish ./src/Bing.Wallpaper/Bing.Wallpaper.csproj <span class=\"token parameter variable\">-c</span> Release <span class=\"token parameter variable\">-o</span> ./test-out <span class=\"token parameter variable\">--runtime</span> linux-x64</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">du</span> <span class=\"token parameter variable\">-sh</span> ./test-out\n161M\t./test-out</code></pre></div>\n<p>dotnet cli 출력 명령 실행중 여러 경고가 출력됩니다.</p>\n<p>그 중, —runtime 을 지정하는 경우  단일 파일로 출력할지 여부를 지정하라는 메시지가 있어, 게시 옵션을 추가합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ dotnet publish ./src/Bing.Wallpaper/Bing.Wallpaper.csproj <span class=\"token parameter variable\">-c</span> Release <span class=\"token parameter variable\">-o</span> ./test-out <span class=\"token parameter variable\">--runtime</span> linux-x64 --no-self-contained</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">du</span> <span class=\"token parameter variable\">-sh</span> ./test-out\n 71M\t./test-out</code></pre></div>\n<p>298 MB 에서 71MB 로 출력 파일의 크기가 줄어들었습니다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/edffe0775d89519e46c44ca363337903/dface/reduce-docker-image-size-001.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA80lEQVR42p2TgW6FIAxF+f+f3RwIAm3vcqtdnPHluTW5WEAPpa1pjIGcM9Z1Ra0VpRSf19bQe8dfLakqlmVxEU7oWhtkTsw5oWowe65Eqog4LKx2w1dVh8H4fCYHcgg7+30almpo47T/5MocWmueNwIZ7X7afmqugs8i6EN8zVQhh24jJIyTa4QnF6JMgSE3w5Dfcdol7MTqbtvmOSQwTgpFUXjhPtVzu6yK1vf3cFcUwhhpAF8nXb1IUxSlKT6KHOAXRfmPqd0UhXQ2MfuO0VLz6MN3GqP/+OSkKEbACI6cnhV/0nWda/yGvgOfXjmA7/rwGyhJtPu1NxnYAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/edffe0775d89519e46c44ca363337903/18dfc/reduce-docker-image-size-001.webp 158w,\n/static/edffe0775d89519e46c44ca363337903/30002/reduce-docker-image-size-001.webp 315w,\n/static/edffe0775d89519e46c44ca363337903/411c4/reduce-docker-image-size-001.webp 600w\"\n              sizes=\"(max-width: 600px) 100vw, 600px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/edffe0775d89519e46c44ca363337903/4d6f2/reduce-docker-image-size-001.png 158w,\n/static/edffe0775d89519e46c44ca363337903/3c1ae/reduce-docker-image-size-001.png 315w,\n/static/edffe0775d89519e46c44ca363337903/dface/reduce-docker-image-size-001.png 600w\"\n            sizes=\"(max-width: 600px) 100vw, 600px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/edffe0775d89519e46c44ca363337903/dface/reduce-docker-image-size-001.png\"\n            alt=\"응용프로그램 출력 크기\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">응용프로그램 출력 크기</figcaption>\n  </figure></p>\n<h3>도커 이미지 빌드 확인</h3>\n<blockquote>\n<p>Apple M1 을 사용하는 로컬 장치에 도커 데스트톱을 설치해서 임의의 버전을 태그로 지정해서 빌드해서 확인을 진행했습니다.</p>\n</blockquote>\n<p>현재 도커 빌드 정의 파일에서 여러 단계의 빌드를 사용하고 있습니다.</p>\n<p>base 별칭을 설정한 이미지를 변경해서 크기를 줄일 수 있을 것으로 생각됩니다.</p>\n<p>기록해두지 않아서 정확하지 않지만,  <code class=\"language-text\">mcr.microsoft.com/dotnet/aspnet:6.0</code> 이미지를 기반으로 작성된 도커 이미지는 약 400 MB 를 초과하는 크기였습니다.</p>\n<p>제공되는 다른 이미지로 시도합니다.</p>\n<blockquote>\n<p><a href=\"https://hub.docker.com/_/microsoft-dotnet-aspnet\">DockerHub: ASP.NET Core Runtime</a> 페이지에서 제공되는 이미지를 모두 확인하실 수 있습니다.</p>\n</blockquote>\n<p>크기가 작을 것으로 예상되는 alpine 이미지를 사용해서 빌드합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/dotnet/aspnet:6.0-alpine <span class=\"token keyword\">AS</span> base</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">docker</span> build <span class=\"token builtin class-name\">.</span> <span class=\"token parameter variable\">-t</span> bbonkr/bing-wallpaper:1.0.3 <span class=\"token parameter variable\">--platform</span> linux/amd64</code></pre></div>\n<p>도커 이미지의 크기는 174.34 MB 입니다.</p>\n<p>매우 많이 줄어들었습니다.</p>\n<p>그런데, 컨테이너 실행시 오류가 발생합니다.</p>\n<p>오류 메시지는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"plaintext\"><pre class=\"language-plaintext\"><code class=\"language-plaintext\">Unhandled exception. System.Globalization.CultureNotFoundException: Only the invariant culture is supported in globalization-invariant mode. See https://aka.ms/GlobalizationInvariantMode for more information. (Parameter 'name')\n\nen-us is an invalid culture identifier.</code></pre></div>\n<p>관련 내용을 찾아보면, apline 에서는 지역화 기능을 사용할 수 없습니다.</p>\n<blockquote>\n<p><a href=\"https://andrewlock.net/dotnet-core-docker-and-cultures-solving-culture-issues-porting-a-net-core-app-from-windows-to-linux/#the-fix-install-the-icu-cultures-and-disable-globalization-invariant-mode\">The fix: install the ICU cultures and disable Globalization Invariant Mode</a></p>\n</blockquote>\n<p>.NET 지역화 기능을 사용할 필요가 없으면, 도커 빌드 정의에 아래 정보를 추가해서 빌드하면 됩니다.</p>\n<blockquote>\n<p>base 별칭이 지정된 이미지에서 아래 명령이 실행되어야 합니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk add --no-cache icu-libs krb5-libs libgcc libintl libssl1.1 libstdc++ zlib</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false</span></code></pre></div>\n<p>메인 프로젝트 파일을 열고 아래 정보를 추가합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>InvariantGlobalization</span><span class=\"token punctuation\">></span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>InvariantGlobalization</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>응용 프로그램에서 필요한 다른 의존 라이브러리가 있다면, 모두 찾아서 설치해야 합니다.</p>\n<p>매우 불편합니다.</p>\n<p>크기를 조금 더 커지더라도, 편리하게 사용하기 위해 Debian 기반 이미지로 변경합니다.</p>\n<p>dockerfile 의 base 단계 이미지를 변경합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/dotnet/aspnet:6.0-bullseye-slim <span class=\"token keyword\">AS</span> base</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">docker</span> build <span class=\"token builtin class-name\">.</span> <span class=\"token parameter variable\">-t</span> bbonkr/bing-wallpaper:1.0.6 <span class=\"token parameter variable\">--platform</span> linux/amd64</code></pre></div>\n<p>도커 이미지의 크기는 282.32 MB 입니다.</p>\n<p>컨테이너를 실행하면 정상적으로 실행됩니다.</p>\n<p>혹시나 다른 이슈가 있으면 대응하기 위해 자주 사용하는 Ubuntu 기반 이미지로 변경합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/dotnet/aspnet:6.0-focal <span class=\"token keyword\">AS</span> base</span></code></pre></div>\n<p>도커 이미지의 크기는 283.68 MB 입니다.</p>\n<p>컨테이너를 실행하면 정상적으로 실행됩니다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ba983bf46c288819ee1a231e33b86b1f/dface/reduce-docker-image-size-002.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABFUlEQVR42p1Ti26EMAzj/38UAQLG8WhpST05LKWgk7ZdJKsJoY6TQBVjhHMO3ns9iX3f8alVIoJlWTDPM2IMcD6ARVJKkJT0fELkjjJXkfU4DiWh7THhaxWguGzkLE4fJWDvyUXIFtmy5pHgdsFEUqSbUsb0XZAbDnkopLoQQq7Ei5u/SE9i0WdUv3jB+gP68RDNK+EwDDo/W4QpIgkvvDaqOMfAmCOwIlexQmHf99i2TedoCg1GOrsrppLynRK5ZbbLGdIsYQt5Dv5J8JaQ6kha2rmE/1kmpENCgvPkx80iHIV9o/QtNjBe1zX7VJkJuWkm67rGNE1Kzvm2bYumaTIs7roO4zjqyWdcrhL+tTVT8duv9w1rpLFxpVFM8gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ba983bf46c288819ee1a231e33b86b1f/18dfc/reduce-docker-image-size-002.webp 158w,\n/static/ba983bf46c288819ee1a231e33b86b1f/30002/reduce-docker-image-size-002.webp 315w,\n/static/ba983bf46c288819ee1a231e33b86b1f/411c4/reduce-docker-image-size-002.webp 600w\"\n              sizes=\"(max-width: 600px) 100vw, 600px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ba983bf46c288819ee1a231e33b86b1f/4d6f2/reduce-docker-image-size-002.png 158w,\n/static/ba983bf46c288819ee1a231e33b86b1f/3c1ae/reduce-docker-image-size-002.png 315w,\n/static/ba983bf46c288819ee1a231e33b86b1f/dface/reduce-docker-image-size-002.png 600w\"\n            sizes=\"(max-width: 600px) 100vw, 600px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ba983bf46c288819ee1a231e33b86b1f/dface/reduce-docker-image-size-002.png\"\n            alt=\"도커 이미지 크기\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">도커 이미지 크기</figcaption>\n  </figure></p>\n<h2>완료</h2>\n<p>작성되는 도커 이미지 크기를 조정한 후 GitHub Actions 워크플로우에서 사설 도커 레지스트리에 업로드하는 동작도 정상적으로 실행됩니다.</p>\n<p><a href=\"https://github.com/bbonkr/bing-wallpaper/actions/workflows/docker.yml\"><img src=\"https://github.com/bbonkr/bing-wallpaper/actions/workflows/docker.yml/badge.svg\" alt=\"docker image\"></a></p>","frontmatter":{"title":"Reduce docker image size","date":"2022-04-14","description":null,"categories":["computing","log"],"tags":["docker","dotnet","dotnet 6","aspnetcore"],"github":{"owner":"bbonkr","repo":"bing-wallpaper"},"featuredImage":null,"draft":null,"comments":false}},"previous":{"fields":{"slug":"/2022/01/20/git-hub-action-git-tag-check-action/"},"frontmatter":{"title":"GitHub Action: Git Tag Check Action","draft":null,"comments":null,"featuredImage":null}},"next":{"fields":{"slug":"/2022/04/28/typescript-project-with-eslint-8/"},"frontmatter":{"title":"Typescript project with eslint@8","draft":null,"comments":false,"featuredImage":null}}},"pageContext":{"id":"c9b66ce3-0836-515b-bfe7-34a86dff1abe","previousPostId":"8f7a99a4-7ded-51b8-9c46-6a5967d79729","nextPostId":"d830e400-6cdf-5d24-8287-3e0c97948bd2"}},"staticQueryHashes":["2644450635","3199328057"],"slicesMap":{}}